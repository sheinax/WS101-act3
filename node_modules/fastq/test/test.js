'use strict'

/* eslint-disable no-var */

var test = require('tape')
var buildQueue = require('../')

test('concurrency', function (t) {
  t.plan(6)
  t.throws(buildQueue.bind(null, worker, 0))
  t.throws(buildQueue.bind(null, worker, NaN))
  t.doesNotThrow(buildQueue.bind(null, worker, 1))

  var queue = buildQueue(worker, 1)
  t.throws(function () {
    queue.concurrency = 0
  })
  t.throws(function () {
    queue.concurrency = NaN
  })
  t.doesNotThrow(function () {
    queue.concurrency = 2
  })

  function worker (arg, cb) {
    cb(null, true)
  }
})

test('worker execution', function (t) {
  t.plan(3)

  var queue = buildQueue(worker, 1)

  queue.push(42, function (err, result) {
    t.error(err, 'no error')
    t.equal(result, true, 'result matches')
  })

  function worker (arg, cb) {
    t.equal(arg, 42)
    cb(null, true)
  }
})

test('limit', function (t) {
  t.plan(4)

  var expected = [10, 0]
  var queue = buildQueue(worker, 1)

  queue.push(10, result)
  queue.push(0, result)

  function result (err, arg) {
    t.error(err, 'no error')
    t.equal(arg, expected.shift(), 'the result matches')
  }

  function worker (arg, cb) {
    setTimeout(cb, arg, null, arg)
  }
})

test('multiple executions', function (t) {
  t.plan(15)

  var queue = buildQueue(worker, 1)
  var toExec = [1, 2, 3, 4, 5]
  var count = 0

  toExec.forEach(function (task) {
    queue.push(task, done)
  })

  function done (err, result) {
    t.error(err, 'no error')
    t.equal(result, toExec[count - 1], 'the result matches')
  }

  function worker (arg, cb) {
    t.equal(arg, toExec[count], 'arg matches')
    count++
    setImmediate(cb, null, arg)
  }
})

test('multiple executions, one after another', function (t) {
  t.plan(15)

  var queue = buildQueue(worker, 1)
  var toExec = [1, 2, 3, 4, 5]
  var count = 0

  queue.push(toExec[0], done)

  function done (err, result) {
    t.error(err, 'no error')
    t.equal(result, toExec[count - 1], 'the result matches')
    if (count < toExec.length) {
      queue.push(toExec[count], done)
    }
  }

  function worker (arg, cb) {
    t.equal(arg, toExec[count], 'arg matches')
    count++
    setImmediate(cb, null, arg)
  }
})

test('set this', function (t) {
  t.plan(3)

  var that = {}
  var queue = buildQueue(that, worker, 1)

  queue.push(42, function (err, result) {
    t.error(err, 'no error')
    t.equal(this, that, 'this matches')
  })

  function worker (arg, cb) {
    t.equal(this, that, 'this matches')
    cb(null, true)
  }
})

test('drain', function (t) {
  t.plan(4)

  var queue = buildQueue(worker, 1)
  var worked = false

  queue.push(42, function (err, result) {
    t.error(err, 'no error')
    t.equal(result, true, 'result matches')
  })

  queue.drain = function () {
    t.equal(true, worked, 'drained')
  }

  function worker (arg, cb) {
    t.equal(arg, 42)
    worked = true
    setImmediate(cb, null, true)
  }
})

test('pause && resume', function (t) {
  t.plan(13)

  var queue = buildQueue(worker, 1)
  var worked = false
  var expected = [42, 24]

  t.notOk(queue.paused, 'it should not be paused')

  queue.pause()

  queue.push(42, function (err, result) {
    t.error(err, 'no error')
    t.equal(result, true, 'result matches')
  })

  queue.push(24, function (err, result) {
    t.error(err, 'no error')
    t.equal(result, true, 'result matches')
  })

  t.notOk(worked, 'it should be paused')
  t.ok(queue.paused, 'it should be paused')

  queue.resume()
  queue.pause()
  queue.resume()
  queue.resume() // second resume is a no-op

  function worker (arg, cb) {
    t.notOk(queue.paused, 'it should not be paused')
    t.ok(queue.running() <= queue.concurrency, 'should respect the concurrency')
    t.equal(arg, expected.shift())
    worked = true
    process.nextTick(function () { cb(null, true) })
  }
})

test('pause in flight && resume', function (t) {
  t.plan(16)

  var queue = buildQueue(worker, 1)
  var expected = [42, 24, 12]

  t.notOk(queue.paused, 'it should not be paused')

  queue.push(42, function (err, result) {
    t.error(err, 'no error')
    t.equal(result, true, 'result matches')
    t.ok(queue.paused, 'it should be paused')
    process.nextTick(function () {
      queue.resume()
      queue.pause()
      queue.resume()
    })
  })

  queue.push(24, function (err, result) {
    t.error(err, 'no error')
    t.equal(result, true, 'result matches')
    t.notOk(queue.paused, 'it should not be paused')
  })

  queue.push(12, function (err, result) {
    t.error(err, 'no error')
    t.equal(result, true, 'result matches')
    t.notOk(queue.paused, 'it should not be paused')
  })

  queue.pause()

  function worker (arg, cb) {
    t.ok(queue.running() <= queue.concurrency, 'should respect the concurrency')
    t.equal(arg, expected.shift())
    process.nextTick(function () { cb(null, true) })
  }
})

test('altering concurrency', function (t) {
  t.plan(24)

  var queue = buildQueue(worker, 1)

  queue.push(24, workDone)
  queue.push(24, workDone)
  queue.push(24, workDone)

  queue.pause()

  queue.concurrency = 3 // concurrency changes are ignored while paused
  queue.concurrency = 2

  queue.resume()

  t.equal(queue.running(), 2, '2 jobs running')

  queue.concurrency = 3

  t.equal(queue.running(), 3, '3 jobs running')

  queue.concurrency = 1

  t.equal(queue.running(), 3, '3 jobs running') // running jobs can't be killed

  queue.push(24, workDone)
  queue.push(24, workDone)
  queue.push(24, workDone)
  queue.push(24, workDone)

  function workDone (err, result) {
    t.error(err, 'no error')
    t.equal(result, true, 'result matches')
  }

  function worker (arg, cb) {
    t.ok(queue.running() <= queue.concurrency, 'should respect the concurrency')
    setImmediate(function () {
      cb(null, true)
    })
  }
})

test('idle()', function (t) {
  t.plan(12)

  var queue = buildQueue(worker, 1)

  t.ok(queue.idle(), 'queue is idle')

  queue.push(42, function (err, result) {
    t.error(err, 'no error')
    t.equal(result, true, 'result matches')
    t.notOk(queue.idle(), 'queue is not idle')
  })

  queue.push(42, function (err, result) {
    t.error(err, 'no error')
    t.equal(result, true, 'result matches')
    // it will go idle after executing this function
    setImmediate(function () {
      t.ok(queue.idle(), 'queue is now idle')
    })
  })

  t.notOk(queue.idle(), 'queue is not idle')

  function worker (arg, cb) {
    t.notOk(queue.idle(), 'queue is not idle')
    t.equal(arg, 42)
    setImmediate(cb, null, true)
  }
})

test('saturated', function (t) {
  t.plan(9)

  var queue = buildQueue(worker, 1)
  var preworked = 0
  var worked = 0

  queue.saturated = function () {
    t.pass('saturated')
    t.equal(preworked, 1, 'started 1 task')
    t.equal(worked, 0, 'worked zero task')
  }

  queue.push(42, done)
  queue.push(42, done)

  function done (err, result) {
    t.error(err, 'no error')
    t.equal(result, true, 'result matches')
  }

  function worker (arg, cb) {
    t.equal(arg, 42)
    preworked++
    setImmediate(function () {
      worked++
      cb(null, true)
    })
  }
})

test('length', function (t) {
  t.plan(7)

  var queue = buildQueue(worker, 1)

  t.equal(queue.length(), 0, 'nothing waiting')
  queue.push(42, done)
  t.equal(queue.length(), 0, 'nothing waiting')
  queue.push(42, done)
  t.equal(queue.length(), 1, 'one task waiting')
  queue.push(42, done)
  t.equal(queue.length(), 2, 'two tasks waiting')

  function done (err, result) {
    t.error(err, 'no error')
  }

  function worker (arg, cb) {
    setImmediate(function () {
      cb(null, true)
    })
  }
})

test('getQueue', function (t) {
  t.plan(10)

  var queue = buildQueue(worker, 1)

  t.equal(queue.getQueue().length, 0, 'nothing waiting')
  queue.push(42, done)
  t.equal(queue.getQueue().length, 0, 'nothing waiting')
  queue.push(42, done)
  t.equal(queue.getQueue().length, 1, 'one task waiting')
  t.equal(queue.getQueue()[0], 42, 'should be equal')
  queue.push(43, done)
  t.equal(queue.getQueue().length, 2, 'two tasks waiting')
  t.equal(queue.getQueue()[0], 42, 'should be equal')
  t.equal(queue.getQueue()[1], 43, 'should be equal')

  function done (err, result) {
    t.error(errlity    ğÿÿÿ    Tˆz¯ÚğÿÿÿX    Ø  Øÿÿÿvk	       áõ   TimeStamp       èÿÿÿTˆz¯ÚTˆz¯Ú    Ğÿÿÿvk    H  áõ   SupportedRenderTriggers ğÿÿÿ  ¥LIz¯Ú˜ÿÿÿnk  br!„¢Ù            °2 ÿÿÿÿ    ÿÿÿÿh  ÿÿÿÿ>                      ContentCourtesyEngine    ÿÿÿlf
 `  Cach  CommX  Cont   ContÀö  Mobià  Plac  Sche0  Serv	  Subs O Trig        €ÿÿÿnk  œÁ%Kr©Ù   ˜         (" ÿÿÿÿ    ÿÿÿÿh  ÿÿÿÿx                   )   CourtesyConfigurationExperienceProperties       ¨ÿÿÿnk  Çvş	_‡Ù              ÿÿÿÿÿÿÿÿ    ÿÿÿÿh  ÿÿÿÿ                       noBlock øÿÿÿ€)  hbin                            ÿÿÿnk  —ú.O¢Ù   Àö          ÿÿÿÿÿÿÿÿ    ÿÿÿÿh  ÿÿÿÿ                    
   NamespacesÙ     ÿÿÿnk  Çvş	_‡Ù   h          ÿÿÿÿÿÿÿÿ    ÿÿÿÿh  ÿÿÿÿ                       SuggestedApps   ğÿÿÿlf €   Sugg ÿÿÿnk  Çvş	_‡Ù   0          ÿÿÿÿÿÿÿÿ    ÿÿÿÿh  ÿÿÿÿ                       SuggestedApps   ğÿÿÿlf ğ   Sugg ÿÿÿnk  Çvş	_‡Ù   è          ÿÿÿÿÿÿÿÿ    ÿÿÿÿh  ÿÿÿÿ                       SuggestedApps   ğÿÿÿlf `!  Sugg ÿÿÿnk  Çvş	_‡Ù   @          ÿÿÿÿÿÿÿÿ    ÿÿÿÿh  ÿÿÿÿ                       SuggestedApps   ğÿÿÿlf È Impr˜ÿÿÿnk  Ülp®Ú   à         (o  ÿÿÿÿ   ĞH h  ÿÿÿÿ$       F             SubscribedContent-314559ğÿÿÿ    nB“ªÚğÿÿÿlf €&  Suggğÿÿÿ    Â^z¯Úğÿÿÿlf °™ Cour ÿÿÿnk  ±¡O_‡Ù   @"          ÿÿÿÿÿÿÿÿ
   hH h  ÿÿÿÿ        h   	          SuggestedApps   ˜ÿÿÿnk  /|^®Ú   à         æ ÿÿÿÿ   Xî h  ÿÿÿÿ$       F             SubscribedContent-338387 ÿÿÿnk  Çvş	_‡Ù   H#          ÿÿÿÿÿÿÿÿ    ÿÿÿÿh  ÿÿÿÿ                       SuggestedApps   ˜ÿÿÿnk  à€^®Ú   à         ¸Å ÿÿÿÿ   ø h  ÿÿÿÿ$       F             SubscribedContent-338388 ÿÿÿnk  Çvş	_‡Ù   $          ÿÿÿÿÿÿÿÿ    ÿÿÿÿh  ÿÿÿÿ                       SuggestedApps      ıÏD“ªÚíÙ˜ÿÿÿnk  ¥§…^®Ú   à         èü  ÿÿÿÿ   °ÿ  h  ÿÿÿÿ$       F             SubscribedContent-338389 ÿÿÿnk  ì/q$_‡Ù   `          ÿÿÿÿÿÿÿÿ    ÿÿÿÿh  ÿÿÿÿ                       SuggestedAppsubs ÿÿÿnk  Çvş	_‡Ù   è$          ÿÿÿÿÿÿÿÿ    ÿÿÿÿh  ÿÿÿÿ                       SuggestedApps   ÿÿÿnk  R‘‘^®Ú   à         ¸"  ÿÿÿÿ   àï h  ÿÿÿÿ       F             SubscribedContent-88000045       ÿÿÿnk  Çvş	_‡Ù    &          ÿÿÿÿÿÿÿÿ    ÿÿÿÿh  ÿÿÿÿ                       SuggestedApps   Èÿÿÿvk    È"  áõ   ConsecutiveRenderFailureCount   àÿÿÿĞ  À     P    à&      ÿÿÿnk  Çvş	_‡Ù   X          ÿÿÿÿÿÿÿÿ    ÿÿÿÿh  ÿÿÿÿ                       CourtesyScenarioDeferredUpdates Èÿÿÿvk 	   ˜  áõ   DefaultEnabledStateInitialized  ¨ÿÿÿnk  [~ã]®Ú   	         ĞW  ÿÿÿÿ   ÈC h  ÿÿÿÿ¸       6             314559  Èÿÿÿvk 	   p(  áõ   DefaultEnabledStateInitialized  ğÿÿÿÇvş	_‡Ù   ¨ÿÿÿnk  ĞóU^®Ú   	         ¨~ ÿÿÿÿ   °Å h  ÿÿÿÿP       6             338387  Øÿÿÿvk     )  áõ 00DueDateTime 3145èÿÿÿs¯Bœ* Úó÷sªÚ3383˜ÿÿÿnk  ú“ªÚ   p          ÿÿÿÿÿÿÿÿ   ø  h  ÿÿÿÿ                     SubscribedContent-338387Øÿÿÿvk    ˜  áõ   DueDateTime     Èÿÿÿvk 	   à)  áõ   DefaultEnabledStateInitialized  ğÿÿÿş;
_‡Ù   ¨ÿÿÿnk  /|^®Ú   	  3       XH ÿÿÿÿ   Øš h  ÿÿÿÿP       6             338388  ˜ÿÿÿnk  ¹ªÚ   p          ÿÿÿÿÿÿÿÿ   ˜  h  ÿÿÿÿ                     SubscribedContent-338388Øÿÿÿvk    Ø*  áõ   DueDateTime     èÿÿÿÂ“ÌÚ¹ªÚ    Èÿÿÿvk 	   (+  áõ   DefaultEnabledStateInitialized  ğÿÿÿ^ 
_‡Ù      h ¨ÿÿÿnk  à€^®Ú   	         € ÿÿÿÿ   ` h  ÿÿÿÿP       6             338389  ˜ÿÿÿnk  Ïc“ªÚ   p          ÿÿÿÿÿÿÿÿ   X,  h  ÿÿÿÿ                     SubscribedContent-338389    • Ğÿÿÿvk 	   xu  áõ bsRefreshCacheTaskExecuted    ) èÿÿÿ…x¯»* ÚÏc“ªÚ    øÿÿÿH  Èÿÿÿvk 	   ˜,  áõ   DefaultEnabledStateInitialized  ğÿÿÿ&c

_‡Ù      `,  ¨ÿÿÿnk  lÌŒ^®Ú   	         è ÿÿÿÿ   `š h  ÿÿÿÿ>       6             88000045¨ÿÿÿnk  ¢}ú^®Ú   	          ÿÿÿÿÿÿÿÿ   €X  h  ÿÿÿÿ        6             35369883   8, ÿÿÿnk  ó÷sªÚ   p          ÿÿÿÿÿÿÿÿ   Ø-  h  ÿÿÿÿ                     SubscribedContent-88000045      øÿÿÿØ(  Èÿÿÿvk 0  V áõ   LastPlacementStateReportTimes   Àÿÿÿvk! p  @[ áõ t LastPlacementPermittedToRunValues‡Ùé'
Øÿÿÿp  ¨  è	  0
  Ø  ¸    Ø.  €.  Ğÿÿÿvk ¨   Q áõ   LastPlacementStates     ğÿÿÿ    jÍV]®Úèÿÿÿ       Çj±]®Ú< Èÿÿÿvk    ¨  áõ t LastPlacementStateReportTimeé'
˜ÿÿÿnk  ÂN
_‡Ù   °          ÿÿÿÿÿÿÿÿ    ÿÿÿÿh  ÿÿÿÿ                       SubscribedContent-314559Ğÿÿÿvk 	   `°  áõ   LastSelectionEmptynts/  ¨ÿÿÿnk  £4ÀíÙ    ˆO         ÿÿÿÿÿÿÿÿ    ÿÿÿÿh  ÿÿÿÿ                       BQAAAA==hbin p                         ğÿÿÿlf Ğ Imprğÿÿÿlf   ImprĞÿÿÿvk x   @¨ áõ  OfflineTimeDatapointstapğÿÿÿlf @W Imprÿÿÿnk  `„‡øÃíÙ   `z          ÿÿÿÿÿÿÿÿ    ÿÿÿÿh  ÿÿÿÿ                       1692856825`128000000001627409`0aøÿÿÿ€Ò  Ğÿÿÿvk x   º áõ  OfflineTimeDatapointsf ğÿÿÿ   Ğ¦è~ªÚèÿÿÿà° ØT €˜ P  øp ğÿÿÿ   é ÍªÚğÿÿÿ¸° °§  lf     Imprèÿÿÿé ÍªÚé ÍªÚ  ğÿÿÿğ6 H˜ oper   oOp]èÿÿÿ|w;§* ÚüÍï~ªÚ)!èíøÿÿÿh£ ğÿÿÿ    ësªÚÈÿÿÿvk    h|  áõ e RetryUpdateRenderTriggers†Ù    ÿÿÿnk  «QÃÌªÚ   à         ¨N ÿÿÿÿ   X¸  h  ÿÿÿÿ       <             SubscribedContent-88000105      (ÿÿÿlf 0  Feat`  Subsğu  SubsXv  Subsè  Subs@  Subsh  Subs@"  SubsH#  Subs$  Subsè$  SubsÈ  Subs0  Subs&  Subsr SubsĞ<  Subs@=  Subs°=  Subs                                                                 úÿÿL         S u b s c r i b e d C o n t e n t -